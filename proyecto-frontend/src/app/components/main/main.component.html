<section class="container mt-5">
  <h1 class="text-center mb-4">Recursos Académicos</h1>
  <section class="mb-5">
    <h2 class="h4" *ngIf="subscriptions.length">Mis suscripciones</h2>
    <div class="list-group mb-4" *ngIf="subscriptions.length">
      <div class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let s of subscriptions">
        <div>
          <strong>{{ s.nombre_asignatura }} - {{ s.nombre_variante }}</strong>
          <span class="badge bg-secondary ms-2">{{ s.rol | titlecase }}</span>
        </div>
        <button class="btn btn-outline-danger btn-sm" (click)="toggleSubState(s.idVariante, 'inactiva')">Desactivar</button>
      </div>
    </div>
  </section>
  <section>
    <div class="card mb-3" *ngFor="let sub of subjects">
      <div class="card-header">
        <h3 class="h5 mb-0">{{ sub.nombre }}</h3>
      </div>
      <div class="card-body">
        <div class="card mb-2" *ngFor="let variant of (sub.idAsignatura | asyncVariants | async)">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ variant.nombre }}</strong>
              <span class="badge bg-secondary ms-2" *ngIf="subscriptions | getUserRole:variant.idVariante as role">{{ role | titlecase }}</span>
              <span class="badge bg-success ms-2" *ngIf="subscriptions | hasSubscription:variant.idVariante">Ya estás suscrito</span>
            </div>
            <div>
              <button class="btn btn-outline-primary btn-sm me-2" (click)="loadResources(variant.idVariante)" [disabled]="loadingResources || selectedVariantId === variant.idVariante">
                {{ selectedVariantId === variant.idVariante ? 'Recursos cargados' : 'Cargar recursos' }}
              </button>
              <button class="btn btn-outline-success btn-sm" (click)="openSubscribeOverlay(variant.idVariante)" *ngIf="!(subscriptions | hasSubscription:variant.idVariante)">Suscribirse</button>
              <button class="btn btn-outline-primary btn-sm" (click)="openUploadOverlay(variant.idVariante)" *ngIf="(subscriptions | getUserRole:variant.idVariante) === 'admin'">Subir recurso</button>
            </div>
          </div>
          <div class="card-body" *ngIf="selectedVariantId === variant.idVariante">
            <div class="card mb-2" *ngFor="let r of resources | filterByVariant:variant.idVariante">
              <div class="card-body">
                <h4 class="card-title h6">{{ r.titulo }} <small class="text-muted">({{ r.tipo }})</small></h4>
                <p class="card-text" *ngIf="r.descripcion">{{ r.descripcion }}</p>
                <a (click)="downloadResource(r.idRecurso)" class="btn btn-link">Descargar PDF</a>
                <button class="btn btn-outline-danger btn-sm" (click)="deleteResource(r.idRecurso)" *ngIf="(subscriptions | getUserRole:variant.idVariante) === 'admin'">Eliminar</button>
                <div class="mt-3" *ngIf="evaluations | filterByResource:r.idRecurso as evals">
                  <div class="card" *ngFor="let eval of evals">
                    <div class="card-body">
                      <p class="mb-1"><strong>Evaluación:</strong> {{ eval.fecha_inicio | date:'short' }} - {{ eval.fecha_fin | date:'short' }}</p>
                      <p class="mb-0">{{ eval.instrucciones }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="alert alert-info text-center" *ngIf="!(resources | filterByVariant:variant.idVariante).length && !loadingResources">
              No hay recursos disponibles para esta variante.
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <div class="modal fade" [ngClass]="{'show d-block': showUploadOverlay}" tabindex="-1" *ngIf="showUploadOverlay">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Subir recurso</h5>
          <button type="button" class="btn-close" (click)="closeUploadOverlay()" aria-label="Close"></button>
        </div>
        <form (ngSubmit)="uploadResource($event)" class="modal-body">
          <div class="mb-3">
            <input type="text" class="form-control" [(ngModel)]="uploadForm.titulo" name="titulo" placeholder="Título" required>
          </div>
          <div class="mb-3">
            <textarea class="form-control" [(ngModel)]="uploadForm.descripcion" name="descripcion" placeholder="Descripción"></textarea>
          </div>
          <div class="mb-3">
            <select class="form-select" [(ngModel)]="uploadForm.tipo" name="tipo">
              <option value="material">Material</option>
              <option value="actividad_aprendizaje">Actividad</option>
              <option value="leccion">Lección</option>
              <option value="evaluacion">Evaluación</option>
            </select>
          </div>
          <div class="mb-3">
            <input type="file" class="form-control" name="file" accept="application/pdf" (change)="onFileChange($event)" required>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" (click)="closeUploadOverlay()">Cancelar</button>
            <button type="submit" class="btn btn-primary">Enviar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" [ngClass]="{'show d-block': showSubscribeOverlay}" tabindex="-1" *ngIf="showSubscribeOverlay">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Suscribirse a variante</h5>
          <button type="button" class="btn-close" (click)="closeSubscribeOverlay()" aria-label="Close"></button>
        </div>
        <form (ngSubmit)="subscribe(subscribeForm.idVariante)" class="modal-body">
          <div class="mb-3">
            <label for="rol" class="form-label">Rol</label>
            <select class="form-select" [(ngModel)]="subscribeForm.rol" name="rol">
              <option value="suscriptor">Suscriptor</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" (click)="closeSubscribeOverlay()">Cancelar</button>
            <button type="submit" class="btn btn-primary">Suscribirse</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" *ngIf="showUploadOverlay || showSubscribeOverlay"></div>
  <div class="alert alert-danger text-center mt-3" *ngIf="errorMessage">{{ errorMessage }}</div>
</section>
